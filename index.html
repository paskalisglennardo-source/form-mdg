<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MDG Material Form | Wings Group</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* ============================================
   SAP FIORI MORNING HORIZON THEME
   Modern Startup-Style Design System
   ============================================ */

:root {
  /* Morning Horizon Primary Colors */
  --horizon-sunrise: #FF6B35;
  --horizon-dawn: #F7931E;
  --horizon-coral: #FF8C69;
  --horizon-peach: #FFB088;
  
  /* Fiori Blues */
  --fiori-blue: #0A6ED1;
  --fiori-blue-dark: #0854A0;
  --fiori-blue-light: #1B90FF;
  --fiori-sky: #E5F2FF;
  
  /* Semantic Colors */
  --success: #2B7D2B;
  --success-bg: #E8F5E8;
  --warning: #E76500;
  --warning-bg: #FFF4E5;
  --error: #BB0000;
  --error-bg: #FFEBEB;
  --info: #0A6ED1;
  --info-bg: #E5F2FF;
  
  /* Neutrals */
  --bg-primary: #F7F9FC;
  --bg-secondary: #FFFFFF;
  --bg-tertiary: #EEF2F8;
  --surface: #FFFFFF;
  --surface-elevated: #FFFFFF;
  
  /* Text Colors */
  --text-primary: #1D2939;
  --text-secondary: #475467;
  --text-tertiary: #98A2B3;
  --text-inverse: #FFFFFF;
  
  /* Borders */
  --border-light: #E4E7EC;
  --border-medium: #D0D5DD;
  --border-focus: var(--fiori-blue);
  
  /* Shadows */
  --shadow-xs: 0 1px 2px rgba(16, 24, 40, 0.05);
  --shadow-sm: 0 1px 3px rgba(16, 24, 40, 0.1), 0 1px 2px rgba(16, 24, 40, 0.06);
  --shadow-md: 0 4px 8px -2px rgba(16, 24, 40, 0.1), 0 2px 4px -2px rgba(16, 24, 40, 0.06);
  --shadow-lg: 0 12px 16px -4px rgba(16, 24, 40, 0.08), 0 4px 6px -2px rgba(16, 24, 40, 0.03);
  --shadow-xl: 0 20px 24px -4px rgba(16, 24, 40, 0.08), 0 8px 8px -4px rgba(16, 24, 40, 0.03);
  --shadow-glow: 0 0 0 4px rgba(10, 110, 209, 0.15);
  
  /* Gradients */
  --gradient-horizon: linear-gradient(135deg, var(--horizon-sunrise) 0%, var(--horizon-dawn) 50%, var(--fiori-blue) 100%);
  --gradient-sunrise: linear-gradient(135deg, var(--horizon-coral) 0%, var(--horizon-sunrise) 100%);
  --gradient-blue: linear-gradient(135deg, var(--fiori-blue) 0%, var(--fiori-blue-dark) 100%);
  --gradient-subtle: linear-gradient(180deg, #FFFFFF 0%, #F9FAFB 100%);
  
  /* Animation */
  --transition-fast: 150ms ease;
  --transition-base: 200ms ease;
  --transition-slow: 300ms ease;
  --transition-bounce: 400ms cubic-bezier(0.68, -0.55, 0.265, 1.55);
  
  /* Border Radius */
  --radius-sm: 6px;
  --radius-md: 10px;
  --radius-lg: 14px;
  --radius-xl: 20px;
  --radius-full: 9999px;
}

/* Reset & Base */
*, *::before, *::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html {
  scroll-behavior: smooth;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  line-height: 1.6;
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* ============================================
   HEADER / NAVIGATION
   ============================================ */

.header {
  background: var(--gradient-horizon);
  padding: 0;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: var(--shadow-lg);
}

.header-content {
  max-width: 1400px;
  margin: 0 auto;
  padding: 16px 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.logo-section {
  display: flex;
  align-items: center;
  gap: 14px;
}

.logo-icon {
  width: 44px;
  height: 44px;
  background: rgba(255,255,255,0.2);
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(10px);
}

.logo-icon svg {
  width: 26px;
  height: 26px;
  fill: white;
}

.logo-text {
  color: white;
}

.logo-text h1 {
  font-size: 1.25rem;
  font-weight: 700;
  letter-spacing: -0.5px;
}

.logo-text span {
  font-size: 0.75rem;
  opacity: 0.85;
  font-weight: 400;
}

.header-badge {
  background: rgba(255,255,255,0.2);
  backdrop-filter: blur(10px);
  padding: 8px 16px;
  border-radius: var(--radius-full);
  color: white;
  font-size: 0.8rem;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 8px;
}

.status-dot {
  width: 8px;
  height: 8px;
  background: #4ADE80;
  border-radius: 50%;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.7; transform: scale(1.1); }
}

/* ============================================
   MAIN CONTAINER
   ============================================ */

.main-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 32px 24px 100px;
}

/* ============================================
   PROGRESS INDICATOR
   ============================================ */

.progress-section {
  margin-bottom: 32px;
}

.progress-steps {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0;
  padding: 24px;
  background: var(--surface);
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-sm);
}

.step {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 20px;
  border-radius: var(--radius-lg);
  transition: var(--transition-base);
}

.step.active {
  background: var(--fiori-sky);
}

.step.completed .step-number {
  background: var(--success);
  color: white;
}

.step-number {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--border-light);
  color: var(--text-tertiary);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 0.875rem;
  transition: var(--transition-base);
}

.step.active .step-number {
  background: var(--fiori-blue);
  color: white;
}

.step-label {
  font-size: 0.875rem;
  color: var(--text-tertiary);
  font-weight: 500;
  transition: var(--transition-base);
}

.step.active .step-label,
.step.completed .step-label {
  color: var(--text-primary);
}

.step-connector {
  width: 60px;
  height: 2px;
  background: var(--border-light);
  margin: 0 8px;
}

.step-connector.active {
  background: var(--fiori-blue);
}

/* ============================================
   CARDS - CRITICAL OVERFLOW FIX
   ============================================ */

.section-card {
  background: var(--surface);
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-sm);
  margin-bottom: 24px;
  border: 1px solid var(--border-light);
  transition: var(--transition-base);
  position: relative;
}

.section-card:hover {
  box-shadow: var(--shadow-md);
}

.section-header {
  padding: 20px 24px;
  border-bottom: 1px solid var(--border-light);
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--gradient-subtle);
  border-radius: var(--radius-xl) var(--radius-xl) 0 0;
}

.section-title {
  display: flex;
  align-items: center;
  gap: 12px;
}

.section-icon {
  width: 40px;
  height: 40px;
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--fiori-sky);
}

.section-icon svg {
  width: 20px;
  height: 20px;
  stroke: var(--fiori-blue);
}

.section-title h2 {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--text-primary);
}

.section-title p {
  font-size: 0.8rem;
  color: var(--text-tertiary);
  margin-top: 2px;
}

.section-badge {
  padding: 6px 12px;
  background: var(--horizon-sunrise);
  color: white;
  border-radius: var(--radius-full);
  font-size: 0.75rem;
  font-weight: 600;
}

.section-body {
  padding: 24px;
}

/* ============================================
   FORM GRID
   ============================================ */

.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap: 24px;
}

.form-group {
  position: relative;
}

.form-group.full-width {
  grid-column: 1 / -1;
}

.form-label {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--text-secondary);
}

.form-label .required {
  color: var(--error);
}

.form-hint {
  font-size: 0.75rem;
  color: var(--text-tertiary);
  font-weight: 400;
  margin-left: auto;
}

/* ============================================
   INPUTS
   ============================================ */

.input-wrapper {
  position: relative;
}

.input-wrapper .input-icon {
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  width: 18px;
  height: 18px;
  stroke: var(--text-tertiary);
  pointer-events: none;
  transition: var(--transition-base);
}

.input-wrapper.has-icon .form-input {
  padding-left: 44px;
}

.form-input,
.form-select {
  width: 100%;
  padding: 12px 16px;
  font-size: 0.9375rem;
  font-family: inherit;
  color: var(--text-primary);
  background: var(--bg-primary);
  border: 1.5px solid var(--border-light);
  border-radius: var(--radius-md);
  transition: var(--transition-base);
  outline: none;
}

.form-input::placeholder {
  color: var(--text-tertiary);
}

.form-input:hover,
.form-select:hover {
  border-color: var(--border-medium);
  background: var(--surface);
}

.form-input:focus,
.form-select:focus {
  border-color: var(--fiori-blue);
  background: var(--surface);
  box-shadow: var(--shadow-glow);
}

.form-input:focus + .input-icon,
.input-wrapper:focus-within .input-icon {
  stroke: var(--fiori-blue);
}

.form-input:read-only {
  background: var(--bg-tertiary);
  color: var(--text-secondary);
  cursor: not-allowed;
}

.form-select {
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%2398A2B3' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 44px;
}

/* ============================================
   CUSTOM PICKER - PORTAL STYLE (FIXED Z-INDEX)
   ============================================ */

.picker {
  position: relative;
}

/* Dropdown menu - rendered as portal at body level */
.picker-menu {
  position: fixed; /* CRITICAL: Use fixed positioning */
  background: var(--surface);
  border: 1px solid var(--border-medium);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-xl);
  max-height: 320px;
  overflow-y: auto;
  overflow-x: hidden;
  z-index: 99999; /* CRITICAL: Very high z-index */
  opacity: 0;
  transform: translateY(-8px);
  animation: dropdownShow 0.2s ease forwards;
}

@keyframes dropdownShow {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.picker-item {
  padding: 12px 16px;
  cursor: pointer;
  font-size: 0.875rem;
  border-bottom: 1px solid var(--border-light);
  display: flex;
  align-items: center;
  gap: 10px;
  transition: var(--transition-fast);
  background: var(--surface);
}

.picker-item:last-child {
  border-bottom: none;
}

.picker-item:hover {
  background: var(--fiori-sky);
}

.picker-item.selected {
  background: var(--fiori-sky);
}

.picker-item .val {
  font-weight: 600;
  color: var(--text-primary);
}

.picker-item .descTxt {
  color: var(--text-tertiary);
  font-size: 0.8rem;
}

.picker-empty {
  padding: 24px 16px;
  text-align: center;
  color: var(--text-tertiary);
  font-size: 0.875rem;
  background: var(--surface);
}

.picker-empty svg {
  width: 48px;
  height: 48px;
  stroke: var(--border-medium);
  margin-bottom: 12px;
}

/* ============================================
   CHARACTERISTICS SECTION
   ============================================ */

#charCard .section-body {
  padding: 0;
}

#charContainer {
  /* No overflow restrictions */
}

.char-container-empty {
  padding: 48px 24px;
  text-align: center;
  color: var(--text-tertiary);
}

.char-container-empty svg {
  width: 64px;
  height: 64px;
  stroke: var(--border-medium);
  margin-bottom: 16px;
}

.char-container-empty h3 {
  font-size: 1rem;
  color: var(--text-secondary);
  margin-bottom: 8px;
}

.char-row {
  display: grid;
  grid-template-columns: 280px 1fr;
  gap: 20px;
  padding: 20px 24px;
  border-bottom: 1px solid var(--border-light);
  align-items: start;
  transition: var(--transition-fast);
  position: relative;
}

.char-row:hover {
  background: var(--bg-tertiary);
}

.char-row:last-child {
  border-bottom: none;
}

.char-row.hidden {
  display: none !important;
}

.char-info {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.char-name {
  font-weight: 600;
  font-size: 0.9375rem;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 8px;
}

.char-desc {
  font-size: 0.8rem;
  color: var(--text-tertiary);
}

/* Tags / Pills */
.tag {
  display: inline-flex;
  align-items: center;
  padding: 3px 8px;
  font-size: 0.7rem;
  font-weight: 500;
  border-radius: var(--radius-full);
}

.tag-info {
  background: var(--info-bg);
  color: var(--info);
}

.tag-warning {
  background: var(--warning-bg);
  color: var(--warning);
}

.tag-success {
  background: var(--success-bg);
  color: var(--success);
}

.tag-required {
  background: var(--error-bg);
  color: var(--error);
}

/* ============================================
   BUTTONS
   ============================================ */

.btn-group {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-top: 24px;
}

.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 12px 24px;
  font-size: 0.9375rem;
  font-weight: 600;
  font-family: inherit;
  border-radius: var(--radius-md);
  border: none;
  cursor: pointer;
  transition: var(--transition-base);
  text-decoration: none;
}

.btn svg {
  width: 18px;
  height: 18px;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.btn-primary {
  background: var(--gradient-blue);
  color: white;
  box-shadow: var(--shadow-sm);
}

.btn-primary:hover:not(:disabled) {
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
}

.btn-primary:active:not(:disabled) {
  transform: translateY(0);
}

.btn-sunrise {
  background: var(--gradient-sunrise);
  color: white;
  box-shadow: var(--shadow-sm);
}

.btn-sunrise:hover:not(:disabled) {
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
}

.btn-secondary {
  background: var(--surface);
  color: var(--text-primary);
  border: 1.5px solid var(--border-medium);
}

.btn-secondary:hover:not(:disabled) {
  background: var(--bg-tertiary);
  border-color: var(--text-tertiary);
}

.btn-ghost {
  background: transparent;
  color: var(--fiori-blue);
  padding: 12px 16px;
}

.btn-ghost:hover:not(:disabled) {
  background: var(--fiori-sky);
}

/* ============================================
   SUMMARY CARD
   ============================================ */

.summary-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
}

.summary-item {
  padding: 16px;
  background: var(--bg-tertiary);
  border-radius: var(--radius-md);
  transition: var(--transition-base);
}

.summary-item:hover {
  background: var(--fiori-sky);
}

.summary-label {
  font-size: 0.75rem;
  color: var(--text-tertiary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 6px;
}

.summary-value {
  font-size: 1rem;
  font-weight: 600;
  color: var(--text-primary);
  word-break: break-word;
}

.summary-value.highlight {
  color: var(--fiori-blue);
}

/* ============================================
   WHATSAPP CS CHAT WIDGET
   ============================================ */

.wa-widget {
  position: fixed;
  bottom: 24px;
  right: 24px;
  z-index: 1000;
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 12px;
}

.wa-bubble {
  background: var(--surface);
  padding: 16px 20px;
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-xl);
  max-width: 320px;
  position: relative;
  opacity: 0;
  transform: translateY(20px) scale(0.95);
  transition: var(--transition-slow);
  pointer-events: none;
  border: 1px solid var(--border-light);
}

.wa-bubble.show {
  opacity: 1;
  transform: translateY(0) scale(1);
  pointer-events: all;
}

.wa-bubble::after {
  content: '';
  position: absolute;
  bottom: -8px;
  right: 32px;
  width: 16px;
  height: 16px;
  background: var(--surface);
  border: 1px solid var(--border-light);
  border-top: none;
  border-left: none;
  transform: rotate(45deg);
}

.wa-bubble-close {
  position: absolute;
  top: 8px;
  right: 8px;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  border: none;
  background: var(--bg-tertiary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--transition-fast);
}

.wa-bubble-close:hover {
  background: var(--border-medium);
}

.wa-bubble-close svg {
  width: 14px;
  height: 14px;
  stroke: var(--text-tertiary);
}

.wa-bubble-content {
  display: flex;
  gap: 12px;
}

.wa-bubble-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--success);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.wa-bubble-avatar svg {
  width: 22px;
  height: 22px;
  fill: white;
}

.wa-bubble-text {
  flex: 1;
}

.wa-bubble-text p {
  font-size: 0.875rem;
  color: var(--text-primary);
  line-height: 1.5;
  margin-bottom: 12px;
}

.wa-bubble-text .wa-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 16px;
  background: #25D366;
  color: white;
  font-size: 0.8125rem;
  font-weight: 600;
  border-radius: var(--radius-md);
  text-decoration: none;
  transition: var(--transition-fast);
}

.wa-bubble-text .wa-btn:hover {
  background: #20BD5A;
  transform: translateY(-1px);
}

.wa-bubble-text .wa-btn svg {
  width: 16px;
  height: 16px;
  fill: white;
}

.wa-fab {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: #25D366;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: var(--shadow-lg);
  transition: var(--transition-base);
  position: relative;
}

.wa-fab:hover {
  transform: scale(1.05);
  box-shadow: var(--shadow-xl);
}

.wa-fab svg {
  width: 32px;
  height: 32px;
  fill: white;
}

.wa-fab-badge {
  position: absolute;
  top: -4px;
  right: -4px;
  width: 20px;
  height: 20px;
  background: var(--error);
  color: white;
  font-size: 0.7rem;
  font-weight: 700;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: bounce 2s infinite;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-4px); }
}

.wa-widget.hidden {
  display: none;
}

/* ============================================
   LOADING STATES
   ============================================ */

.skeleton {
  background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--border-light) 50%, var(--bg-tertiary) 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
  border-radius: var(--radius-sm);
}

@keyframes shimmer {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

.loading-overlay {
  position: fixed;
  inset: 0;
  background: rgba(255,255,255,0.9);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  gap: 20px;
}

.loading-spinner {
  width: 48px;
  height: 48px;
  border: 4px solid var(--border-light);
  border-top-color: var(--fiori-blue);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-text {
  font-size: 1rem;
  color: var(--text-secondary);
}

/* ============================================
   TOAST NOTIFICATIONS
   ============================================ */

.toast-container {
  position: fixed;
  top: 24px;
  right: 24px;
  z-index: 100000;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.toast {
  padding: 16px 20px;
  background: var(--surface);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-xl);
  display: flex;
  align-items: center;
  gap: 12px;
  min-width: 320px;
  max-width: 480px;
  transform: translateX(120%);
  animation: slideIn 0.3s ease forwards;
  border-left: 4px solid;
}

@keyframes slideIn {
  to { transform: translateX(0); }
}

.toast.success {
  border-left-color: var(--success);
}

.toast.error {
  border-left-color: var(--error);
}

.toast.info {
  border-left-color: var(--info);
}

.toast-icon {
  width: 24px;
  height: 24px;
  flex-shrink: 0;
}

.toast-content {
  flex: 1;
}

.toast-title {
  font-weight: 600;
  font-size: 0.9375rem;
  color: var(--text-primary);
}

.toast-message {
  font-size: 0.8125rem;
  color: var(--text-secondary);
  margin-top: 2px;
}

/* ============================================
   RESPONSIVE
   ============================================ */

@media (max-width: 768px) {
  .header-content {
    padding: 12px 16px;
  }
  
  .header-badge {
    display: none;
  }
  
  .main-container {
    padding: 20px 16px 120px;
  }
  
  .progress-steps {
    flex-wrap: wrap;
    gap: 8px;
    padding: 16px;
  }
  
  .step-connector {
    display: none;
  }
  
  .step {
    padding: 8px 12px;
    font-size: 0.8rem;
  }
  
  .form-grid {
    grid-template-columns: 1fr;
  }
  
  .char-row {
    grid-template-columns: 1fr;
    gap: 12px;
    padding: 16px;
  }
  
  .summary-grid {
    grid-template-columns: 1fr;
  }
  
  .wa-bubble {
    max-width: calc(100vw - 48px);
    right: 0;
  }
  
  .btn-group {
    flex-direction: column;
  }
  
  .btn {
    width: 100%;
  }
}

/* ============================================
   ANIMATIONS
   ============================================ */

.fade-in {
  animation: fadeIn 0.3s ease forwards;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.slide-up {
  animation: slideUp 0.4s ease forwards;
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(30px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Focus visible for accessibility */
:focus-visible {
  outline: 2px solid var(--fiori-blue);
  outline-offset: 2px;
}

/* Scrollbar styling */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: var(--bg-tertiary);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: var(--border-medium);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--text-tertiary);
}

/* Hidden utility */
.hidden {
  display: none !important;
}

/* Auto-filled server indicator */
.server-auto::after {
  content: 'Auto';
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  background: var(--success-bg);
  color: var(--success);
  font-size: 0.7rem;
  font-weight: 600;
  padding: 2px 8px;
  border-radius: var(--radius-full);
}
</style>
</head>
<body>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
  <div class="loading-spinner"></div>
  <div class="loading-text">Loading form data...</div>
</div>

<!-- Toast Container -->
<div id="toastContainer" class="toast-container"></div>

<!-- Header -->
<header class="header">
  <div class="header-content">
    <div class="logo-section">
      <div class="logo-icon">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2L2 7L12 12L22 7L12 2Z"/>
          <path d="M2 17L12 22L22 17"/>
          <path d="M2 12L12 17L22 12"/>
        </svg>
      </div>
      <div class="logo-text">
        <h1>MDG Material Form</h1>
        <span>Wings Group Master Data Governance</span>
      </div>
    </div>
    <div class="header-badge">
      <span class="status-dot"></span>
      System Online
    </div>
  </div>
</header>

<!-- Main Container -->
<main class="main-container">
  
  <!-- Progress Steps -->
  <section class="progress-section">
    <div class="progress-steps">
      <div class="step active" data-step="1">
        <div class="step-number">1</div>
        <span class="step-label">Select Class</span>
      </div>
      <div class="step-connector"></div>
      <div class="step" data-step="2">
        <div class="step-number">2</div>
        <span class="step-label">Fill Details</span>
      </div>
      <div class="step-connector"></div>
      <div class="step" data-step="3">
        <div class="step-number">3</div>
        <span class="step-label">Review</span>
      </div>
      <div class="step-connector"></div>
      <div class="step" data-step="4">
        <div class="step-number">4</div>
        <span class="step-label">Submit</span>
      </div>
    </div>
  </section>

  <!-- Selection Section -->
  <section class="section-card slide-up" style="animation-delay: 0.1s">
    <div class="section-header">
      <div class="section-title">
        <div class="section-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
            <polyline points="3.27,6.96 12,12.01 20.73,6.96"/>
            <line x1="12" y1="22.08" x2="12" y2="12"/>
          </svg>
        </div>
        <div>
          <h2>Material Classification</h2>
          <p>Select class, company, and server source</p>
        </div>
      </div>
      <span class="section-badge">Step 1</span>
    </div>
    <div class="section-body">
      <div class="form-grid">
        <!-- Class Input -->
        <div class="form-group">
          <label class="form-label" for="classInput">
            Material Class <span class="required">*</span>
            <span class="form-hint">Search or select</span>
          </label>
          <div class="picker" id="classPicker">
            <div class="input-wrapper has-icon">
              <input type="text" id="classInput" class="form-input" placeholder="Start typing to search classes..." autocomplete="off"/>
              <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
              </svg>
            </div>
          </div>
          <div id="classInfo" class="char-desc" style="margin-top:8px"></div>
        </div>
        
        <!-- Company Select -->
        <div class="form-group">
          <label class="form-label" for="companySelect">
            Use for Company <span class="required">*</span>
            <span class="form-hint">Server auto-filled</span>
          </label>
          <select id="companySelect" class="form-select">
            <option value="">Select company...</option>
            <option value="PT Sayap Mas Utama">PT Sayap Mas Utama</option>
            <option value="PT Multi Indo Mandiri">PT Multi Indo Mandiri</option>
            <option value="PT Prakarsa Alam Segar">PT Prakarsa Alam Segar</option>
            <option value="PT Aneka Mitra Gemilang">PT Aneka Mitra Gemilang</option>
            <option value="PT Tirta Alam Segar">PT Tirta Alam Segar</option>
            <option value="PT Wings Surya">PT Wings Surya</option>
            <option value="PT Karunia Alam Segar">PT Karunia Alam Segar</option>
          </select>
        </div>
        
        <!-- Server Source (Auto-filled) -->
        <div class="form-group">
          <label class="form-label" for="serverSource">
            Server Source <span class="required">*</span>
            <span class="form-hint">Auto from company</span>
          </label>
          <div class="input-wrapper has-icon" id="serverWrapper">
            <input type="text" id="serverSource" class="form-input" placeholder="Select company first..." readonly/>
            <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="2" width="20" height="8" rx="2" ry="2"/>
              <rect x="2" y="14" width="20" height="8" rx="2" ry="2"/>
              <line x1="6" y1="6" x2="6.01" y2="6"/>
              <line x1="6" y1="18" x2="6.01" y2="18"/>
            </svg>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Characteristics Section -->
  <section class="section-card slide-up" style="animation-delay: 0.2s" id="charCard">
    <div class="section-header">
      <div class="section-title">
        <div class="section-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14,2 14,8 20,8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
            <polyline points="10,9 9,9 8,9"/>
          </svg>
        </div>
        <div>
          <h2>Material Characteristics</h2>
          <p>Fill in the required attribute values</p>
        </div>
      </div>
      <span class="section-badge" id="charCount">Step 2</span>
    </div>
    <div class="section-body" style="padding:0">
      <div id="charContainer">
        <div class="char-container-empty">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
            <polyline points="3.27,6.96 12,12.01 20.73,6.96"/>
            <line x1="12" y1="22.08" x2="12" y2="12"/>
          </svg>
          <h3>No Class Selected</h3>
          <p>Please select a material class above to view characteristics</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Summary Section -->
  <section class="section-card slide-up" style="animation-delay: 0.3s">
    <div class="section-header">
      <div class="section-title">
        <div class="section-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 11l3 3L22 4"/>
            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
          </svg>
        </div>
        <div>
          <h2>Summary & Review</h2>
          <p>Review your material data before submission</p>
        </div>
      </div>
      <span class="section-badge">Step 3</span>
    </div>
    <div class="section-body">
      <div class="summary-grid">
        <div class="summary-item">
          <div class="summary-label">Server Source</div>
          <div class="summary-value" id="sumServer">-</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">CR / MID</div>
          <div class="summary-value" id="sumCrMid">-</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Company</div>
          <div class="summary-value" id="sumCompany">-</div>
        </div>
        <div class="summary-item" style="grid-column: 1 / -1">
          <div class="summary-label">Material Description</div>
          <div class="summary-value highlight" id="sumMatDesc">-</div>
        </div>
      </div>
      
      <div class="btn-group">
        <button id="genBtn" class="btn btn-secondary">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
            <circle cx="12" cy="12" r="3"/>
          </svg>
          Preview Summary
        </button>
        <button id="submitBtn" class="btn btn-sunrise">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="22" y1="2" x2="11" y2="13"/>
            <polygon points="22,2 15,22 11,13 2,9 22,2"/>
          </svg>
          Submit Form
        </button>
      </div>
    </div>
  </section>

</main>

<!-- WhatsApp CS Widget -->
<div id="waWidget" class="wa-widget hidden">
  <div id="waBubble" class="wa-bubble">
    <button class="wa-bubble-close" id="waBubbleClose">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"/>
        <line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </button>
    <div class="wa-bubble-content">
      <div class="wa-bubble-avatar">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
        </svg>
      </div>
      <div class="wa-bubble-text">
        <p>ðŸ‘‹ Hi! Tidak menemukan class untuk material yang ingin Anda buat?</p>
        <a href="#" id="waLink" class="wa-btn" target="_blank">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
          </svg>
          Chat via WhatsApp
        </a>
      </div>
    </div>
  </div>
  <button class="wa-fab" id="waFab">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
    </svg>
    <span class="wa-fab-badge">1</span>
  </button>
</div>

<script>
// ============================================
// CONFIGURATION
// ============================================
const DATA_URL = './data/form_data.json';

// NEW SUBMIT URL
const SUBMIT_URL = 'https://script.google.com/macros/s/AKfycbwJl6rthe-IUpKjTmiUM69Flau-9KHlp1DLfeJBuld-x4_ZkseUqW9aIrxv_VmqFDWp/exec';

// Company to Server Mapping
const COMPANY_SERVER_MAP = {
  'PT Sayap Mas Utama': 'SPR',
  'PT Multi Indo Mandiri': 'SPR',
  'PT Prakarsa Alam Segar': 'SPE',
  'PT Aneka Mitra Gemilang': 'APE',
  'PT Tirta Alam Segar': 'TPR',
  'PT Wings Surya': 'SPR',
  'PT Karunia Alam Segar': 'SPR'
};

// WhatsApp Numbers based on Class Type
const WA_NUMBERS = {
  ZSI: '+6282110232751',
  ZPI: '+6285162728998',
  ZSR: '+6285162728998'
};

// Dependency Rules
const DEPS = {
  'EMBOSSED_BRAND_WINGS': { 'YES': { 'BRAND_WING': true } },
  'EXTERNAL_BRAND': { 'YES': { 'NO_SERI_BRAND_EXTERNAL_PI': false, 'BRAND_EXTERNAL_PI': true } },
  'HAS_SPESIFIC_COLOUR': { 'YES': { 'COLOUR': true } },
  'SPEC_QTY_IN_ONE_BUNDLE': { 'YES': { 'QTY_IN_ONE_BUNDLE': true } },
  'ITEM_SHAPE': {
    'PERSEGI': { 'WIGTH_PCS_PI': true, 'SIZE_UNIT_DIMENSI': true },
    'BULAT': { 'DIAMETER_PCS_PI': true }
  }
};

let CONFIG = null;
let waBubbleShown = false;
let waBubbleDismissed = false;
let activePickerMenu = null;
let activePickerInput = null;

// ============================================
// UTILITY FUNCTIONS
// ============================================

function applyCase(value, flag) {
  if (!value) return value;
  flag = (flag || '').toUpperCase();
  if (flag === 'U') return value.toUpperCase();
  if (flag === 'L') return value.toLowerCase();
  if (flag === 'P') return value.replace(/\w\S*/g, w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase());
  return value;
}

function showToast(type, title, message) {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  
  const icons = {
    success: '<svg viewBox="0 0 24 24" fill="none" stroke="#2B7D2B" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22,4 12,14.01 9,11.01"/></svg>',
    error: '<svg viewBox="0 0 24 24" fill="none" stroke="#BB0000" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
    info: '<svg viewBox="0 0 24 24" fill="none" stroke="#0A6ED1" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>'
  };
  
  toast.innerHTML = `
    <div class="toast-icon">${icons[type]}</div>
    <div class="toast-content">
      <div class="toast-title">${title}</div>
      <div class="toast-message">${message}</div>
    </div>
  `;
  
  container.appendChild(toast);
  setTimeout(() => {
    toast.style.animation = 'slideIn 0.3s ease reverse forwards';
    setTimeout(() => toast.remove(), 300);
  }, 4000);
}

function updateProgressStep(step) {
  document.querySelectorAll('.step').forEach((el, idx) => {
    el.classList.remove('active', 'completed');
    if (idx + 1 < step) el.classList.add('completed');
    if (idx + 1 === step) el.classList.add('active');
  });
  document.querySelectorAll('.step-connector').forEach((el, idx) => {
    el.classList.toggle('active', idx + 1 < step);
  });
}

// ============================================
// COMPANY -> SERVER AUTO-FILL
// ============================================

function setupCompanyServerDependency() {
  const companySelect = document.getElementById('companySelect');
  const serverInput = document.getElementById('serverSource');
  const serverWrapper = document.getElementById('serverWrapper');
  
  companySelect.addEventListener('change', (e) => {
    const company = e.target.value;
    const server = COMPANY_SERVER_MAP[company] || '';
    
    serverInput.value = server;
    
    if (server) {
      serverWrapper.classList.add('server-auto');
      showToast('info', 'Server Auto-filled', `Server set to ${server} based on company selection`);
    } else {
      serverWrapper.classList.remove('server-auto');
    }
    
    checkShowWaWidget();
  });
}

// ============================================
// WHATSAPP WIDGET
// ============================================

function checkShowWaWidget() {
  const classVal = document.getElementById('classInput').value.trim();
  const serverVal = document.getElementById('serverSource').value.trim();
  const widget = document.getElementById('waWidget');
  const bubble = document.getElementById('waBubble');
  
  if (classVal && serverVal) {
    widget.classList.remove('hidden');
    updateWaLink(classVal, serverVal);
    
    if (!waBubbleShown && !waBubbleDismissed) {
      setTimeout(() => {
        bubble.classList.add('show');
        waBubbleShown = true;
      }, 1500);
    }
  } else {
    widget.classList.add('hidden');
    bubble.classList.remove('show');
  }
}

function updateWaLink(classVal, serverVal) {
  const waLink = document.getElementById('waLink');
  let phoneNumber = WA_NUMBERS.ZSI;
  
  const classUpper = classVal.toUpperCase();
  if (classUpper.startsWith('ZPI') || classUpper.startsWith('ZSR')) {
    phoneNumber = WA_NUMBERS.ZPI;
  } else if (classUpper.startsWith('ZSI')) {
    phoneNumber = WA_NUMBERS.ZSI;
  }
  
  const message = encodeURIComponent(
    `Hi, saya Requestor MID dari ${serverVal} dan saya tidak menemukan class yang saya butuhkan. Bisa tolong dibantu?`
  );
  
  waLink.href = `https://wa.me/${phoneNumber.replace(/[^0-9]/g, '')}?text=${message}`;
}

function initWaWidget() {
  const fab = document.getElementById('waFab');
  const bubble = document.getElementById('waBubble');
  const closeBtn = document.getElementById('waBubbleClose');
  
  fab.addEventListener('click', () => {
    bubble.classList.toggle('show');
  });
  
  closeBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    bubble.classList.remove('show');
    waBubbleDismissed = true;
  });
  
  document.getElementById('classInput').addEventListener('input', checkShowWaWidget);
  document.getElementById('classInput').addEventListener('change', checkShowWaWidget);
  document.getElementById('serverSource').addEventListener('input', checkShowWaWidget);
}

// ============================================
// PORTAL-STYLE DROPDOWN - FIXED Z-INDEX
// ============================================

function closeAllPickerMenus() {
  if (activePickerMenu) {
    activePickerMenu.remove();
    activePickerMenu = null;
    activePickerInput = null;
  }
}

function positionMenu(menu, input) {
  const rect = input.getBoundingClientRect();
  const menuHeight = Math.min(320, window.innerHeight - rect.bottom - 20);
  
  menu.style.position = 'fixed';
  menu.style.top = (rect.bottom + 8) + 'px';
  menu.style.left = rect.left + 'px';
  menu.style.width = rect.width + 'px';
  menu.style.maxHeight = menuHeight + 'px';
}

function createPortalMenu(input, items, onSelect) {
  closeAllPickerMenus();
  
  const menu = document.createElement('div');
  menu.className = 'picker-menu';
  activePickerMenu = menu;
  activePickerInput = input;
  
  if (items.length === 0) {
    menu.innerHTML = `
      <div class="picker-empty">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <circle cx="11" cy="11" r="8"/>
          <line x1="21" y1="21" x2="16.65" y2="16.65"/>
        </svg>
        <div>No matching values</div>
      </div>
    `;
  } else {
    items.slice(0, 50).forEach(item => {
      const val = typeof item === 'object' ? item.value : item;
      const desc = typeof item === 'object' ? item.description : '';
      const div = document.createElement('div');
      div.className = 'picker-item';
      div.innerHTML = `
        <span class="val">${val}</span>
        ${desc ? `<span class="descTxt">${desc}</span>` : ''}
      `;
      div.addEventListener('mousedown', (e) => {
        e.preventDefault(); // Prevent blur
        onSelect(val);
        closeAllPickerMenus();
      });
      menu.appendChild(div);
    });
  }
  
  document.body.appendChild(menu);
  positionMenu(menu, input);
}

// ============================================
// DATA LOADING
// ============================================

async function loadData() {
  try {
    const resp = await fetch(DATA_URL);
    if (!resp.ok) throw new Error('Failed to load data');
    CONFIG = await resp.json();
    
    const classList = Object.keys(CONFIG.classes || {});
    const classInput = document.getElementById('classInput');
    
    createClassPicker(classInput, classList);
    
    document.getElementById('loadingOverlay').style.display = 'none';
    showToast('success', 'Data Loaded', `${classList.length} classes available`);
  } catch (err) {
    console.error('Load error:', err);
    document.getElementById('loadingOverlay').innerHTML = `
      <svg viewBox="0 0 24 24" fill="none" stroke="#BB0000" stroke-width="2" style="width:48px;height:48px">
        <circle cx="12" cy="12" r="10"/>
        <line x1="15" y1="9" x2="9" y2="15"/>
        <line x1="9" y1="9" x2="15" y2="15"/>
      </svg>
      <div style="color:#BB0000;font-weight:600">Failed to load form data</div>
      <div style="color:#475467;font-size:0.875rem">Please ensure data/form_data.json exists</div>
    `;
  }
}

// ============================================
// CLASS PICKER
// ============================================

function createClassPicker(input, classes) {
  function showMenu() {
    const val = input.value.toLowerCase();
    const filtered = classes.filter(c => c.toLowerCase().includes(val));
    createPortalMenu(input, filtered, (selected) => {
      input.value = selected;
      input.dispatchEvent(new Event('change'));
    });
  }
  
  input.addEventListener('focus', showMenu);
  input.addEventListener('input', showMenu);
  input.addEventListener('blur', () => {
    setTimeout(closeAllPickerMenus, 150);
  });
}

// ============================================
// VALUE PICKER
// ============================================

function createValuePicker(input, allowed, allowAdditional = false) {
  const wrapper = document.createElement('div');
  wrapper.className = 'picker';
  wrapper.appendChild(input);
  
  function showMenu() {
    const val = input.value.toLowerCase();
    const filtered = allowed.filter(item => {
      const v = (typeof item === 'object' ? item.value : item).toLowerCase();
      return v.includes(val);
    });
    createPortalMenu(input, filtered, (selected) => {
      input.value = selected;
      input.dispatchEvent(new Event('change'));
    });
  }
  
  input.addEventListener('focus', showMenu);
  input.addEventListener('input', showMenu);
  input.addEventListener('blur', () => {
    setTimeout(closeAllPickerMenus, 150);
  });
  
  return wrapper;
}

// ============================================
// RENDER CHARACTERISTICS
// ============================================

function renderCharacteristics(cls) {
  const container = document.getElementById('charContainer');
  const items = CONFIG.classes[cls] || [];
  
  if (items.length === 0) {
    container.innerHTML = `
      <div class="char-container-empty">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
          <polyline points="13,2 13,9 20,9"/>
        </svg>
        <h3>No Characteristics</h3>
        <p>This class has no defined characteristics</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = '';
  
  const sorted = [...items].sort((a, b) => (a.sequence || 0) - (b.sequence || 0));
  
  sorted.forEach((item, idx) => {
    const charName = item.characteristic;
    const row = document.createElement('div');
    row.className = 'char-row fade-in';
    row.style.animationDelay = `${idx * 0.03}s`;
    row.dataset.charName = charName;
    
    const left = document.createElement('div');
    left.className = 'char-info';
    
    const nameEl = document.createElement('div');
    nameEl.className = 'char-name';
    nameEl.innerHTML = charName.replace(/_/g, ' ');
    
    if (item.case) nameEl.innerHTML += `<span class="tag tag-info">Case: ${item.case}</span>`;
    if (item.prefix) nameEl.innerHTML += `<span class="tag tag-info">Prefix: ${item.prefix}</span>`;
    if (item.suffix) nameEl.innerHTML += `<span class="tag tag-info">Suffix: ${item.suffix}</span>`;
    if ((item.without_space || '').toUpperCase() === 'Y') {
      nameEl.innerHTML += `<span class="tag tag-warning">No Space</span>`;
    }
    
    const attr = CONFIG.char_attr?.[charName] || {};
    if (attr.entry_required) {
      nameEl.innerHTML += `<span class="tag tag-required">Required</span>`;
    }
    
    left.appendChild(nameEl);
    
    const descEl = document.createElement('div');
    descEl.className = 'char-desc';
    descEl.textContent = CONFIG.char_desc?.[charName] || '';
    left.appendChild(descEl);
    
    const right = document.createElement('div');
    right.style.flex = '1';
    
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'form-input';
    input.placeholder = 'Enter value...';
    input.dataset.sequence = item.sequence || 0;
    input.dataset.charName = charName;
    input.dataset.case = item.case || '';
    input.dataset.prefix = item.prefix || '';
    input.dataset.suffix = item.suffix || '';
    input.dataset.withoutSpace = item.without_space || item.withoutSpace || '';
    if (attr.entry_required) input.required = true;
    
    const allowed = CONFIG.char_values?.[charName] || [];
    if (allowed.length) {
      const allowAdditional = !!(attr.additional_values);
      right.appendChild(createValuePicker(input, allowed, allowAdditional));
    } else {
      right.appendChild(input);
    }
    
    row.appendChild(left);
    row.appendChild(right);
    container.appendChild(row);
  });
  
  document.getElementById('charCount').textContent = `${sorted.length} Fields`;
  
  evaluateDependencies();
  
  container.querySelectorAll('input').forEach(inp => {
    inp.addEventListener('change', evaluateDependencies);
    inp.addEventListener('input', evaluateDependencies);
  });
  
  updateProgressStep(2);
}

// ============================================
// DEPENDENCIES
// ============================================

function normalizeBool(v) {
  const s = (v || '').toString().trim().toUpperCase();
  if (!s) return null;
  if (['YES', 'Y', 'YA', 'TRUE', '1'].includes(s)) return true;
  if (['NO', 'N', 'TIDAK', 'FALSE', '0'].includes(s)) return false;
  return null;
}

function applySpecialDependencies() {
  const allRows = Array.from(document.querySelectorAll('#charContainer .char-row'));
  const findRowByName = (re) => allRows.filter(r => re.test(r.dataset.charName || ''));

  const embossedTriggers = findRowByName(/EMBOSS/i).filter(r => /DESAIN|DESIGN/i.test(r.dataset.charName || ''));
  const embossedValue = embossedTriggers[0]?.querySelector('input')?.value || '';
  const embossedYes = normalizeBool(embossedValue);
  const desainRows = findRowByName(/DESAI(N|GN)_(YEAR|MONTH|NAME)/i);
  desainRows.forEach(r => {
    if (embossedYes === true) r.classList.remove('hidden');
    else r.classList.add('hidden');
  });

  const itemShapeRow = findRowByName(/ITEM_SHAPE/i)[0];
  const shape = (itemShapeRow?.querySelector('input')?.value || '').trim().toUpperCase();
  const lengthRows = findRowByName(/LENGTH/i);
  const widthRows = findRowByName(/WIDTH/i);
  const heightRows = findRowByName(/HEIGHT/i);
  const diameterRows = findRowByName(/DIAMETER|DIAM/i);

  const hideAllDims = () => {
    [...lengthRows, ...widthRows, ...heightRows, ...diameterRows].forEach(r => r.classList.add('hidden'));
  };

  if (!shape) {
    hideAllDims();
    return;
  }

  if (shape.includes('PERSEGI')) {
    diameterRows.forEach(r => r.classList.add('hidden'));
    lengthRows.forEach(r => r.classList.remove('hidden'));
    widthRows.forEach(r => r.classList.remove('hidden'));
    heightRows.forEach(r => r.classList.remove('hidden'));
  } else if (shape.includes('BULAT')) {
    lengthRows.forEach(r => r.classList.add('hidden'));
    widthRows.forEach(r => r.classList.add('hidden'));
    diameterRows.forEach(r => r.classList.remove('hidden'));
    heightRows.forEach(r => r.classList.remove('hidden'));
  }
}

function evaluateDependencies() {
  document.querySelectorAll('#charContainer .char-row').forEach(row => {
    const charName = row.dataset.charName;
    let depends = false;
    for (const trig in DEPS) {
      for (const val in DEPS[trig]) {
        if (DEPS[trig][val].hasOwnProperty(charName)) {
          depends = true;
          break;
        }
      }
      if (depends) break;
    }
    if (depends) row.classList.add('hidden');
    else row.classList.remove('hidden');
    
    const input = row.querySelector('input');
    if (input) input.required = CONFIG.char_attr?.[charName]?.entry_required || false;
  });

  document.querySelectorAll('#charContainer input').forEach(inp => {
    const trigName = inp.dataset.charName;
    const val = inp.value.trim();
    if (DEPS[trigName] && DEPS[trigName][val]) {
      const deps = DEPS[trigName][val];
      Object.keys(deps).forEach(depChar => {
        const row = document.querySelector(`#charContainer .char-row[data-char-name="${depChar}"]`);
        if (row) {
          row.classList.remove('hidden');
          const mandatory = deps[depChar];
          const depInput = row.querySelector('input');
          if (depInput) depInput.required = mandatory;
        }
      });
    }
  });

  applySpecialDependencies();
}

// ============================================
// MATERIAL DESCRIPTION
// ============================================

function buildMaterialDescription() {
  const inputs = Array.from(document.querySelectorAll('#charContainer input'));
  inputs.sort((a, b) => parseInt(a.dataset.sequence || '0') - parseInt(b.dataset.sequence || '0'));
  
  const parts = [];
  inputs.forEach(inp => {
    const raw = inp.value.trim();
    if (!raw) return;
    const row = inp.closest('.char-row');
    if (row && row.classList.contains('hidden')) return;
    
    let val = applyCase(raw, inp.dataset.case);
    val = (inp.dataset.prefix || '') + val + (inp.dataset.suffix || '');
    const noSpace = (inp.dataset.withoutSpace || '').toUpperCase() === 'Y';
    if (parts.length === 0) parts.push(val);
    else if (noSpace) parts[parts.length - 1] += val;
    else parts.push(val);
  });
  
  return parts.join(' ');
}

// ============================================
// SUMMARY & SUBMIT
// ============================================

function generateSummary() {
  const server = document.getElementById('serverSource').value.trim();
  const company = document.getElementById('companySelect').value.trim();
  const matDesc = buildMaterialDescription();
  
  // Preview summary WITHOUT asking for CR/MID
  document.getElementById('sumServer').textContent = server || '-';
  document.getElementById('sumCrMid').textContent = '(akan diminta saat submit)';
  document.getElementById('sumCompany').textContent = company || '-';
  document.getElementById('sumMatDesc').textContent = matDesc || '-';
  
  updateProgressStep(3);
  showToast('info', 'Summary Generated', 'Please review your data before submitting');
  
  return { server_source: server, company_use_for: company, mat_desc_to_be: matDesc };
}

async function submitForm() {
  const cls = document.getElementById('classInput').value.trim();
  const server = document.getElementById('serverSource').value.trim();
  const company = document.getElementById('companySelect').value.trim();
  const matDesc = buildMaterialDescription();
  
  // Validation
  if (!cls || !server || !company) {
    showToast('error', 'Validation Error', 'Please fill Class, Company, and Server fields');
    return;
  }
  
  // Ask for CR/MID ONLY during submit
  let crmid = '';
  if (server.toUpperCase() === 'SPR') {
    crmid = prompt('Server = SPR\n\nMasukkan CR Number (max 8 karakter):', '') || '';
    if (!crmid) {
      showToast('error', 'CR Number Required', 'Anda harus memasukkan CR Number untuk submit');
      return;
    }
    crmid = crmid.slice(0, 8);
  } else {
    crmid = prompt(`Server = ${server}\n\nMasukkan MID yang sudah terbentuk di ECC (max 8 digit):`, '') || '';
    if (!crmid) {
      showToast('error', 'MID Required', 'Anda harus memasukkan MID untuk submit');
      return;
    }
    crmid = crmid.replace(/\D+/g, '').slice(0, 8);
  }
  
  // Update summary with CR/MID
  document.getElementById('sumCrMid').textContent = crmid;
  
  // Build characteristics as dynamic key-value pairs
  const charData = {};
  document.querySelectorAll('#charContainer .char-row').forEach(row => {
    if (row.classList.contains('hidden')) return;
    
    const inp = row.querySelector('input');
    if (inp && inp.value.trim()) {
      const charName = inp.dataset.charName;
      let val = applyCase(inp.value.trim(), inp.dataset.case);
      val = (inp.dataset.prefix || '') + val + (inp.dataset.suffix || '');
      charData[charName] = val;
    }
  });
  
  // Build payload - flat structure for easy Sheet column mapping
  const payload = {
    timestamp: new Date().toISOString(),
    class: cls,
    server_source: server,
    crmid: crmid,
    company_use_for: company,
    mat_desc_to_be: matDesc,
    // Include all char values as flat keys
    .charData
  };
  
  try {
    showToast('info', 'Submitting...', 'Please wait while we process your request');
    
    await fetch(SUBMIT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify(payload)
    });
    
    updateProgressStep(4);
    showToast('success', 'Form Submitted', 'Your material request has been sent successfully');
  } catch (err) {
    console.error('Submit error:', err);
    showToast('error', 'Submission Failed', 'Please try again or contact support');
  }
}

// ============================================
// SCROLL HANDLER FOR DROPDOWN REPOSITION
// ============================================

window.addEventListener('scroll', () => {
  if (activePickerMenu && activePickerInput) {
    positionMenu(activePickerMenu, activePickerInput);
  }
}, true);

window.addEventListener('resize', () => {
  closeAllPickerMenus();
});

// ============================================
// GLOBAL CLICK HANDLER
// ============================================

document.addEventListener('click', (e) => {
  if (activePickerMenu && !e.target.closest('.picker') && !e.target.closest('.picker-menu')) {
    closeAllPickerMenus();
  }
});

// ============================================
// INITIALIZE
// ============================================

document.addEventListener('DOMContentLoaded', () => {
  loadData();
  initWaWidget();
  setupCompanyServerDependency();
  
  document.getElementById('classInput').addEventListener('change', e => {
    const cls = e.target.value.trim();
    if (!CONFIG || !CONFIG.classes?.[cls]) {
      document.getElementById('classInfo').innerHTML = `
        <span style="color:var(--error)">âš ï¸ Class not found in dataset</span>
      `;
      document.getElementById('charContainer').innerHTML = `
        <div class="char-container-empty">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
          </svg>
          <h3>Class Not Found</h3>
          <p>The selected class is not in the dataset</p>
        </div>
      `;
    } else {
      document.getElementById('classInfo').innerHTML = `
        <span style="color:var(--success)">âœ“ Class found - ${CONFIG.classes[cls].length} characteristics</span>
      `;
      renderCharacteristics(cls);
    }
    checkShowWaWidget();
  });
  
  document.getElementById('genBtn').addEventListener('click', generateSummary);
  document.getElementById('submitBtn').addEventListener('click', submitForm);
});
</script>
</body>
</html>
